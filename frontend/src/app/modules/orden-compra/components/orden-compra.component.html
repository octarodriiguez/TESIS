<div class="ordenes-container">
  <div class="header">
    <div class="breadcrumb">
      <span>Principal</span> > <span class="active">√ìrdenes de Compra</span>
    </div>

    <div class="toolbar">
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="terminoBusqueda"
          placeholder="Buscar por n√∫mero, proveedor o estado..."
          class="search-input"
        />
      </div>

      <button class="btn-nuevo" (click)="abrirFormularioNuevo()">
        + Nueva Orden
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando √≥rdenes de compra...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !loading" class="error-container">
    <p>‚ùå Error al cargar las √≥rdenes de compra</p>
    <button class="btn-retry" (click)="cargarOrdenes()">Reintentar</button>
  </div>

  <!-- Tabla de √≥rdenes -->
  <div *ngIf="!loading && !error" class="tabla-container">
    <table class="tabla-ordenes">
      <thead>
        <tr>
          <th>NRO. ORDEN</th>
          <th>PROVEEDOR</th>
          <th>FECHA SOLICITUD</th>
          <th>FECHA ENTREGA</th>
          <th>ESTADO</th>
          <th>TOTAL</th>
          <th>ACCIONES</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let orden of ordenesFiltradas"
          (click)="abrirDetalle(orden)"
          class="fila-clickeable"
        >
          <td>
            <strong>{{ orden.nroOrden }}</strong>
          </td>
          <td>{{ orden.nombreProveedor }}</td>
          <td>{{ formatearFecha(orden.fechaSolicitud) }}</td>
          <td>{{ formatearFecha(orden.fechaEntregaEstimada || '') }}</td>
          <td>
            <span class="badge" [ngClass]="getEstadoClass(orden.estado)">
              {{ orden.estado }}
            </span>
          </td>
          <td>
            <strong>${{ orden.totalOrden | number:'1.2-2' }}</strong>
          </td>
          <td>
            <div class="acciones">
              <button
                class="btn-eliminar"
                (click)="eliminarOrden(orden, $event)"
                title="Eliminar"
              >
                Eliminar
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <div *ngIf="ordenesFiltradas.length === 0" class="empty-state">
      <div class="empty-icon">üì¶</div>
      <h3>No se encontraron √≥rdenes de compra</h3>
      <p *ngIf="terminoBusqueda">Intenta ajustar los filtros o el t√©rmino de b√∫squeda</p>
      <p *ngIf="!terminoBusqueda">Comienza creando tu primera orden de compra</p>
      <button class="btn-agregar" (click)="abrirFormularioNuevo()">
        + Agregar primer orden
      </button>
    </div>

    <!-- Info Footer -->
    <div *ngIf="ordenesFiltradas.length > 0" class="footer-info">
      Mostrando {{ ordenesFiltradas.length }} de {{ ordenes.length }} √≥rdenes
      <span *ngIf="terminoBusqueda">(filtrado)</span>
    </div>
  </div>

  <!-- Modal Formulario -->
  <app-orden-compra-form
    *ngIf="mostrarFormulario"
    (cerrar)="cerrarFormulario()"
    (ordenCreada)="cargarOrdenes()"
  ></app-orden-compra-form>

  <!-- Modal Detalle -->
  <div *ngIf="mostrarDetalle && ordenSeleccionada" class="modal-overlay" (click)="cerrarDetalle()">
    <div class="modal-detalle" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Detalle de Orden: {{ ordenSeleccionada.nroOrden }}</h2>
        <button class="btn-close" (click)="cerrarDetalle()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="info-grid">
          <div class="info-item">
            <label>Proveedor:</label>
            <span>{{ ordenSeleccionada.nombreProveedor }}</span>
          </div>
          <div class="info-item">
            <label>Estado:</label>
            <span class="badge" [ngClass]="getEstadoClass(ordenSeleccionada.estado)">
              {{ ordenSeleccionada.estado }}
            </span>
          </div>
          <div class="info-item">
            <label>Fecha Solicitud:</label>
            <span>{{ formatearFecha(ordenSeleccionada.fechaSolicitud) }}</span>
          </div>
          <div class="info-item">
            <label>Fecha Entrega Estimada:</label>
            <span>{{ formatearFecha(ordenSeleccionada.fechaEntregaEstimada || '') }}</span>
          </div>
        </div>

        <h3>Insumos</h3>
        <table class="tabla-detalles">
          <thead>
            <tr>
              <th>Insumo</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let detalle of ordenSeleccionada.detalles">
              <td>{{ detalle.nombreInsumo }}</td>
              <td>{{ detalle.cantidad }}</td>
              <td>${{ detalle.precioUnitario | number:'1.2-2' }}</td>
              <td>${{ detalle.subtotal | number:'1.2-2' }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-right"><strong>TOTAL:</strong></td>
              <td><strong>${{ ordenSeleccionada.totalOrden | number:'1.2-2' }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="cerrarDetalle()">Cerrar</button>
      </div>
    </div>
  </div>
</div>